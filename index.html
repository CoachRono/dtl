<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daisy Teituk Library | Digital Campus</title>
    <style>
        /* --- CORE THEME --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #1a1a2e; color: #ffffff; line-height: 1.6; }
        header { background-color: #0f3460; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .logo-circle { width: 45px; height: 45px; background: #e94560; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }
        
        /* --- LAYOUTS --- */
        #library-catalog, #admin-view, #my-downloads, #login-view { padding: 40px 5%; display: none; }
        .section-header { text-align: center; margin-bottom: 40px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        
        /* --- CARDS & BUTTONS --- */
        .book-card { background: #16213e; padding: 25px; border-radius: 12px; text-align: center; border: 1px solid #0f3460; transition: 0.3s; }
        .book-card:hover { border-color: #e94560; transform: translateY(-5px); }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .order-btn { background: #e94560; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: bold; }
        .preview-btn { background: transparent; color: #e94560; border: 1px solid #e94560; padding: 12px; border-radius: 6px; cursor: pointer; flex: 1; }

        /* --- DOWNLOAD ITEMS --- */
        .download-item { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #f39c12; animation: fadeIn 0.5s; }
        .verified-item { border-left-color: #2ecc71; }
        .dl-link { background: #2ecc71; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
        .pending-tag { color: #f39c12; font-weight: bold; font-size: 0.85rem; text-transform: uppercase; }

        /* --- READING MODAL --- */
        #reading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .content-paper { max-width: 800px; margin: 40px auto; background: white; color: #2d3436; padding: 50px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .close-btn { position: sticky; top: 0; float: right; background: #e94560; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* --- ADMIN TABLE --- */
        .admin-table-container { overflow-x: auto; background: #16213e; border-radius: 12px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #0f3460; }
        .verify-btn { background: #0f3460; color: white; border: 1px solid #999; padding: 6px 12px; border-radius: 4px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center;">
        <div class="logo-circle">DTL</div>
        <h1 style="margin:0; font-size:1.1rem; letter-spacing:1px;">DAISY TEITUK LIBRARY</h1>
    </div>
    <nav id="main-nav" style="display:none;">
        <button onclick="showView('library-catalog')" style="background:none; border:none; color:white; cursor:pointer; margin-right:15px; font-weight:bold;">LIBRARY</button>
        <button onclick="showView('my-downloads')" style="background:none; border:none; color:white; cursor:pointer; margin-right:15px; font-weight:bold;">DOWNLOADS</button>
        <button id="logoutBtn" style="background:#e94560; border:none; color:white; padding:6px 12px; border-radius:5px; cursor:pointer;">LOGOUT</button>
    </nav>
</header>

<div id="login-view" style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
    <div style="background: #16213e; padding: 40px; border-radius: 15px; width: 100%; max-width: 350px; border-top: 5px solid #e94560; text-align: center;">
        <h2 id="auth-title">Welcome Back</h2>
        <input type="email" id="email" placeholder="Email Address" style="width:100%; padding:12px; margin-bottom:15px; background:#0f3460; border:none; color:white; border-radius:5px;">
        <input type="password" id="password" placeholder="Password" style="width:100%; padding:12px; margin-bottom:15px; background:#0f3460; border:none; color:white; border-radius:5px;">
        <button id="submitAuth" style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">PROCEED</button>
        <p style="font-size: 13px; margin-top: 20px;">
            <a id="switchAuth" style="color:#e94560; cursor:pointer; text-decoration:none;">Create Account</a> | 
            <a id="forgotPass" style="color:#999; cursor:pointer; text-decoration:none;">Forgot Password?</a>
        </p>
    </div>
</div>

<div id="reading-overlay">
    <button class="close-btn" onclick="closePreview()">CLOSE READER</button>
    <div class="content-paper" id="preview-body"></div>
</div>

<div id="library-catalog">
    <div class="section-header">
        <h2>Academic Resources</h2>
        <p>Choose a subject to preview notes or buy the full topical guide.</p>
    </div>
    <div class="book-grid" id="book-grid-main"></div>
</div>

<div id="my-downloads">
    <div class="section-header">
        <h2>My Study Vault</h2>
        <p>Paid resources will appear here. Verification takes 5-10 minutes.</p>
    </div>
    <div id="unlocked-files-list"></div>
</div>

<div id="admin-view">
    <div class="section-header">
        <h2>Payment Control Panel</h2>
        <p>Verify Till 4449442 transactions.</p>
    </div>
    <div class="admin-table-container">
        <table>
            <thead><tr><th>Student</th><th>Resource</th><th>MPESA Code</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="admin-orders-list"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, orderBy, doc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBtMm3LcHUI-i_Sw6L3o2wYaY1OcAbKY5A",
        authDomain: "daisy-teituk-library.firebaseapp.com",
        projectId: "daisy-teituk-library",
        storageBucket: "daisy-teituk-library.firebasestorage.app",
        messagingSenderId: "255743286704",
        appId: "1:255743286704:web:e96f8adb50fc5891ac8a75",
        measurementId: "G-FLJ8GQNGNF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_EMAIL = "coachrono@gmail.com";

    // --- CONTENT DATABASE ---
    const libraryData = [
        { 
            id: "kisw1", title: "Kigogo: Topical Summary",
            content: `<h1>Kigogo: Muhtasari wa Kiswahili</h1><hr><h3>Dhamira</h3><p>Ashumta Albina anaangazia uongozi wa kiimla na umuhimu wa ukombozi. Soko la Chapakazi ni jazanda ya nchi inayofisadiwa.</p><h3>Wahusika</h3><p><b>Majoka:</b> Kiongozi mkatili. <b>Tunu:</b> Sauti ya mabadiliko.</p>`
        },
        { 
            id: "kisw2", title: "Chozi la Heri Summary",
            content: `<h1>Chozi la Heri: Uchambuzi</h1><hr><h3>Maana ya Anwani</h3><p>Inamaanisha matumaini yanayotokana na magumu. Safari ya wahusika kama Ridhaa inaonyesha uvumilivu.</p><h3>Maudhui</h3><p>Ufisadi, ukatili wa kijinsia, na athari za vita vya kikabila nchini.</p>`
        },
        { 
            id: "geo1", title: "Geo: Earth Movements",
            content: `<h1>Geography: Internal Processes</h1><hr><h3>Folding</h3><p>Forces of compression cause rock layers to bend. Forms Fold Mountains like the Alps.</p><h3>Faulting</h3><p>Crustal fracturing due to tension. This created the Great Rift Valley.</p>`
        },
        { 
            id: "geo2", title: "Geo: Map Work Skills",
            content: `<h1>Geography: Map Reading</h1><hr><h3>Grid References</h3><p>4-figure (general area) and 6-figure (specific point) location techniques.</p><h3>Scaling</h3><p>Converting map distance to actual ground distance using linear scales.</p>`
        }
    ];

    // --- NAV LOGIC ---
    window.showView = (id) => {
        ['login-view', 'library-catalog', 'my-downloads', 'admin-view'].forEach(v => document.getElementById(v).style.display = 'none');
        document.getElementById(id).style.display = 'block';
    };

    const grid = document.getElementById('book-grid-main');
    libraryData.forEach(book => {
        grid.innerHTML += `
            <div class="book-card">
                <h3>${book.title}</h3>
                <p style="font-size:0.9rem; color:#888;">Complete Study Guide</p>
                <div class="btn-group">
                    <button class="preview-btn" onclick="openPreview('${book.id}')">PREVIEW</button>
                    <button class="order-btn" onclick="orderNow('${book.title}')">BUY PDF</button>
                </div>
            </div>
        `;
    });

    window.openPreview = (id) => {
        const book = libraryData.find(b => b.id === id);
        document.getElementById('preview-body').innerHTML = book.content + `<br><hr><p style="color:#e94560; font-weight:bold; text-align:center;">PAY TO UNLOCK FULL PRINTABLE PDF</p>`;
        document.getElementById('reading-overlay').style.display = 'block';
    };

    window.closePreview = () => document.getElementById('reading-overlay').style.display = 'none';

    window.orderNow = async (title) => {
        const code = prompt(`LIPA NA MPESA TILL: 4449442\nResource: ${title}\n\nEnter Code:`);
        if(code) {
            await addDoc(collection(db, "orders"), {
                user: auth.currentUser.email,
                book: title,
                mpesaCode: code.toUpperCase(),
                status: "Pending",
                at: serverTimestamp()
            });
            alert("Payment Sent! Redirecting to Downloads...");
            showView('my-downloads');
        }
    };

    // --- AUTH ---
    let isSignUp = false;
    document.getElementById('switchAuth').onclick = () => {
        isSignUp = !isSignUp;
        document.getElementById('auth-title').innerText = isSignUp ? "Create Account" : "Welcome Back";
        document.getElementById('submitAuth').innerText = isSignUp ? "SIGN UP" : "PROCEED";
    };

    document.getElementById('forgotPass').onclick = () => {
        const em = document.getElementById('email').value;
        if(em) sendPasswordResetEmail(auth, em).then(() => alert("Reset email sent!"));
        else alert("Enter email first.");
    };

    document.getElementById('submitAuth').onclick = () => {
        const em = document.getElementById('email').value, ps = document.getElementById('password').value;
        if(isSignUp) createUserWithEmailAndPassword(auth, em, ps).catch(e => alert(e.message));
        else signInWithEmailAndPassword(auth, em, ps).catch(e => alert(e.message));
    };

    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    // --- REALTIME DATA SYNC ---
    onAuthStateChanged(auth, (u) => {
        if(u) {
            document.getElementById('main-nav').style.display = 'block';
            if(u.email === ADMIN_EMAIL) {
                showView('admin-view');
                onSnapshot(query(collection(db, "orders"), orderBy("at", "desc")), (snap) => {
                    const list = document.getElementById('admin-orders-list');
                    list.innerHTML = "";
                    snap.forEach(d => {
                        const o = d.data();
                        list.innerHTML += `<tr><td>${o.user}</td><td>${o.book}</td><td>${o.mpesaCode}</td><td><span style="color:${o.status==='Verified'?'#2ecc71':'#f39c12'}">${o.status}</span></td><td><button class="verify-btn" onclick="verifyPay('${d.id}', '${o.status}')">Verify</button></td></tr>`;
                    });
                });
            } else {
                showView('library-catalog');
                onSnapshot(query(collection(db, "orders"), where("user", "==", u.email), orderBy("at", "desc")), (snap) => {
                    const dlList = document.getElementById('unlocked-files-list');
                    dlList.innerHTML = snap.empty ? "<p style='text-align:center;'>No orders yet.</p>" : "";
                    snap.forEach(d => {
                        const o = d.data();
                        const isV = o.status === "Verified";
                        dlList.innerHTML += `
                            <div class="download-item ${isV?'verified-item':''}">
                                <div><strong>${o.book}</strong><br><small>Ref: ${o.mpesaCode}</small></div>
                                ${isV ? '<a href="#" class="dl-link">DOWNLOAD PDF</a>' : '<span class="pending-tag">WAITING FOR ADMIN...</span>'}
                            </div>`;
                    });
                });
            }
        } else {
            document.getElementById('main-nav').style.display = 'none';
            showView('login-view');
        }
    });

    window.verifyPay = async (id, cur) => {
        await updateDoc(doc(db, "orders", id), { status: cur === "Verified" ? "Pending" : "Verified" });
    };
</script>
</body>
</html>
